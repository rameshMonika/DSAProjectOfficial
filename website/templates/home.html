{% extends "base.html" %}
{% block title %}Home{% endblock %}{% block content %}

<h1>This is the home page</h1>
<form id="routeForm">
    <div class="form-row">
        <div class="form-group col-md-6">
            <label for="origin">From:</label>
            <input type="text" class="form-control suggestionField" list="suggestionsOrigin" id="origin"
                placeholder="Enter origin"> <datalist id="suggestionsOrigin"></datalist><br>
        </div>
        <div class="form-group col-md-6">
            <label for="source_Origin">To:</label>
            <input type="text" class="form-control suggestionField" list="suggestionsOrigin" id="destination"
                placeholder="Enter origin"> <datalist id="suggestionsDest"></datalist><br>
        </div>
    </div>
    <div class="form-row">
        <div class="form-group col-md-6">
            <label for="departure_date">Date of Departure:</label>
            <input type="date" class="form-control" id="departure_date">
        </div>
        <div class="form-group col-md-6">
            <label for="sortOrder">Sort Order:</label>
            <select class="form-control" id="sortOrder" name="sortOrder">
                <option value="ascending">Distance Ascending</option>
                <option value="descending">Distance Descending</option>
            </select><br>
        </div>
    </div>
    <div class="col-sm-10">
        <div class="form-check">
            <input type="checkbox" id="direct_flight" name="direct_flight" value="true">
            <label for="direct_flight">Direct Flight Only</label><br>
        </div>
    </div>
    <div class="form-group row">
        <div class="col-sm-10">
            <button type="submit" class="btn btn-primary">Search</button>
        </div>
    </div>
</form>
<div class=" mt-3 mb-3">
    <div id="optimalRouteOutput"></div>
    <div id="output"></div>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("origin").addEventListener("input", function () {
                // console.log("Input event fired origin");
                var prefixValue = this.value;
                var xhr = new XMLHttpRequest();
                xhr.open("GET", "/suggest?prefix=" + prefixValue, true);
                xhr.onreadystatechange = function () {
                    if (xhr.readyState == 4 && xhr.status == 200) {
                        var data = JSON.parse(xhr.responseText);
                        // console.log(data)
                        var suggestionsElement2 = document.getElementById("suggestionsOrigin");
                        suggestionsElement2.innerHTML = ""; // Clear the datalist
                        data.forEach(function (suggestion) {
                            var option = document.createElement("option");
                            option.value = suggestion;
                            suggestionsElement2.appendChild(option); // Add each suggestion to the datalist
                        });
                    }
                };
                xhr.send();
            }); document.getElementById("destination").addEventListener("input", function () {
                // console.log("Input event fired dest");
                var prefixValue = this.value;
                var xhr = new XMLHttpRequest();
                xhr.open("GET", "/suggest?prefix=" + prefixValue, true);
                xhr.onreadystatechange = function () {
                    if (xhr.readyState == 4 && xhr.status == 200) {
                        var data = JSON.parse(xhr.responseText);
                        // console.log(data)
                        var suggestionsElement = document.getElementById("suggestionsDest");
                        suggestionsElement.innerHTML = ""; // Clear the datalist
                        data.forEach(function (suggestion) {
                            var option = document.createElement("option");
                            option.value = suggestion;
                            suggestionsElement.appendChild(option); // Add each suggestion to the datalist
                        });
                    }
                };
                xhr.send();
            });
        });
        document.getElementById('routeForm').addEventListener('submit', function (event) {
            event.preventDefault();
            var form = event.target;
            var origin = form.elements.origin.value;
            var destination = form.elements.destination.value;
            var departureDate = form.elements.departure_date.value;
            var directFlight = form.elements.direct_flight.checked;
            var sortOrder = form.elements.sortOrder.value;
            var searchData = {
                origin: origin,
                destination: destination,
                departure_date: departureDate,
                direct_flight: directFlight,
                sortOrder: sortOrder
            };

            // Send data to backend for processing
            fetch('/get_route', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(searchData)
            })
                .then(response => response.json())
                .then(data => {
                    var flightCoordinate = "";
                    console.log(data);
                    if (data[0].indirect_flight_data && data[0].indirect_flight_data.length > 0) {
                        //indirect
                        flightCoordinates = data[2].Allcoordinates[0];
                    }
                    else if (data[0].direct_flight_data && data[0].direct_flight_data.length > 0) {
                        //direct
                        flightCoordinates = data[2].flight_coordinates[0];
                    }

                    // console.log('Flight Coordinates', `);

                    var output = document.getElementById('output');
                    var optimalRouteOutput = document.getElementById('optimalRouteOutput');
                    output.innerHTML = ''; // Clear the output div
                    optimalRouteOutput.innerHTML = ''; // Clear the optimalRouteOutput div

                    if (data[1].hasOwnProperty('optimal_route_data')) {
                        console.log("Optimal Route Section");
                        var route = data[1].optimal_route_data;
                        var routeInfo = "";

                        for (let j = 0; j < route[0][0].length; j++) {
                            routeInfo += route[0][0][j];
                            if (j < route[0][0][j].length - 2) {
                                routeInfo += ' > ';
                            }
                        }

                        est_duration = "";
                        indirect_flight = data[0].indirect_flight_data;
                        direct_flight = data[0].direct_flight_data;

                        if (typeof direct_flight === 'undefined' || direct_flight === null) {
                            //For Optimal Flight =>  Indirect Flight
                            est_duration = indirect_flight[0][4];
                            routeCoordinate = data[2].Allcoordinates[0];
                            route_Coordinate = data[2].Allcoordinates;
                            distance_direct = route[0][2];
                        } else {
                            // For Optimal Flight =>  Direct Flight
                            est_duration = direct_flight[0][4];
                            routeCoordinate = data[2].flight_coordinates[0];
                            route_Coordinate = data[2].flight_coordinates;
                            distance_direct = data[1].optimal_route_data[0][2];
                        }

                        console.log("Optimal total Distance: ", distance_direct);
                        est_duration_com = est_duration[0] + " Hours " + est_duration[1] + " Mins";

                        var codeBlock = `
                        <form action="/OneMap" method="post">
                            <div class="card w-50 mb-2">
                                <div class="card-body">
                                    <span class="badge badge-info">Best Optimal</span>
                                    <h5 class="card-title">Source Airport: ${route[0][0][0]}</h5>
                                    <h5 class="card-title">Destination Airport: ${route[0][0][1]}</h5>
                                    <p class="card-text">Airline: ${route[0][1]} </p>
                                    <p class="card-text">Distance: ${distance_direct} km</p>
                                    <p class="card-text">Price: $${route[0][3]} </p>
                                    <p class="card-text">Route: ${routeInfo}</p>
                                    <button type="submit" class="btn btn-primary">View More</button>
                                </div>
                            </div>
                            <input type="text" style="visibility: hidden;" id="Dest" name="Dest" value="${flightCoordinates[1]}" readonly>
                            <input type="text" style="visibility: hidden;" id="Source" name="Source" value="${flightCoordinates[0]}"
                                readonly>
                            <input type="text" style="visibility: hidden;" id="FlightRoutes" name="FlightRoutes" value="${routeInfo}"
                                readonly>
                            <input type="text" style="visibility: hidden;" id="flightPrice" name="flightPrice" value="${route[0][3]}"
                                readonly>
                            <input type="text" style="visibility: hidden;" id="ETA" name="ETA" value="${est_duration_com}" readonly>
                            <input type="text" style="visibility: hidden;" id="totalDistance" name="totalDistance"
                                value="${distance_direct}" readonly>
                            <input type="text" style="visibility: hidden;" id="allCoordinate" name="allCoordinate"
                                value="${routeCoordinate}" readonly>
                        </form>`;

                        optimalRouteOutput.innerHTML += codeBlock;
                    }

                    var encounteredClasses = {}; // Object to keep track of encountered classes

                    for (var i = 1; i < route_Coordinate.length; i += 2) {
                        if (data[0].hasOwnProperty('direct_flight_data')) {
                            console.log("Direct Flight Section");
                            counter = 1;
                            while (data[0].direct_flight_data.length > 0 && counter < (data[0].direct_flight_data.length)) {
                                // console.log("direct flight data Counter: ", counter);
                                // console.log("data[0].direct_flight_data.length", data[0].direct_flight_data.length);
                                var htmlContent = "";
                                var directEstTime = data[0].direct_flight_data[counter][4][0] + " Hours " + data[0].direct_flight_data[counter][4][1] + " Mins";
                                var route = data[0].direct_flight_data[counter];
                                var routeInfo = "";
                                for (let j = 0; j < route[0].length; j++) {
                                    routeInfo += route[0][j];
                                    if (j < route[0].length - 1) {
                                        routeInfo += ' > ';
                                    }
                                }
                                // console.log('One data', route)

                                htmlContent += `
                                <form action="/OneMap" method="post">
                                    <div class="card w-50 mb-2">
                                        <div class="card-body">
                                            <h5 class="card-title">Source Airport: ${route[0][0]}</h5>
                                            <h5 class="card-title">Destination Airport: ${route[0][route[0].length - 1]}</h5>
                                            <p class="card-text">Distance: ${route[1]} km</p>
                                            <p class="card-text">Airline: ${route[2]} </p>
                                            <p class="card-text">Price: $${route[3]} </p>
                                            <p class="card-text">Route: ${routeInfo}</p>
                                            <button type="submit" class="btn btn-primary">View More</button>
                                        </div>
                                    </div>

                                    <input type="text" style="visibility: hidden;" id="Source" name="Source"
                                        value="${data[2].flight_coordinates[0]}" readonly>
                                    <input type="text" style="visibility: hidden;" id="Dest" name="Dest" value="${data[2].flight_coordinates[1]}"
                                        readonly>
                                    <input type="text" style="visibility: hidden;" id="flightPrice" name="flightPrice" value="${route[3]}" readonly>
                                    <input type="text" style="visibility: hidden;" id="ETA" name="ETA" value="${directEstTime}" readonly>
                                    <input type="text" style="visibility: hidden;" name="FlightRoutes" value="${routeInfo}" readonly>
                                    <input type="text" style="visibility: hidden;" name="totalDistance" value="${route[1]}" readonly>
                                    <input type="text" style="visibility: hidden;" name="allCoordinate" value="${data[2].flight_coordinates}"
                                        readonly>
                                </form>
                                        `;
                                counter += 1;
                                output.innerHTML += htmlContent; // Append the HTML content
                            }

                        } else if (data.hasOwnProperty('error')) {
                            output.innerHTML += `<p>${data.error}</p>`;
                        } else {
                            if (data[0].indirect_flight_data.length > 0) {
                                console.log("Indirect Flight Section");

                                var htmlContent = "";
                                for (var y = 0; y < data[0].indirect_flight_data.length; y++) {
                                    var indirectEstTime = data[0].indirect_flight_data[y][4][0] + " Hours " + data[0].indirect_flight_data[y][4][1] + " Mins";
                                    var route = data[0].indirect_flight_data[y];
                                    var routeInfo = "";
                                    for (let j = 0; j < route[0].length; j++) {
                                        routeInfo += route[0][j];
                                        if (j < route[0].length - 1) {
                                            routeInfo += ' > ';
                                        }
                                    }
                                    if (!encounteredClasses[route[1]]) {
                                        // If not encountered, add it to the encountered classes set
                                        encounteredClasses[route[1]] = true;
                                        htmlContent += `
                                        <form action="/OneMap" method="post">
                                            <div class="card w-50 mb-2 ${route[1]}">
                                                <div class="card-body">
                                                    <h5 class="card-title">Source Airport: ${route[0][0]}</h5>
                                                    <h5 class="card-title">Destination Airport: ${route[0][route[0].length - 1]}</h5>
                                                    <p class="card-text">Distance: ${route[1]} km</p>
                                                    <p class="card-text">Airline: ${route[2]} </p>
                                                    <p class="card-text">Price: $${route[3]} </p>
                                                    <p class="card-text">Route: ${routeInfo}</p>
                                                    <button type="submit" class="btn btn-primary">View More</button>
                                                </div>
                                            </div>
                                            <input type="text" style="visibility: hidden;" id="Dest" name="Dest" value="${flightCoordinates[1]}" readonly>
                                            <input type="text" style="visibility: hidden;" id="flightPrice" name="flightPrice" value="${route[3]}" readonly>
                                            <input type="text" style="visibility: hidden;" id="Source" name="Source" value="${flightCoordinates[0]}"
                                                readonly>
                                            <input type="text" style="visibility: hidden;" id="FlightRoutes" name="FlightRoutes" value="${routeInfo}"
                                                readonly>
                                            <input type="text" style="visibility: hidden;" name="ETA" id="ETA" value="${indirectEstTime}" readonly>
                                            <input type="text" style="visibility: hidden;" id="totalDistance" name="totalDistance" value="${route[1]}"
                                                readonly>
                                            <input type="text" style="visibility: hidden;" id="allCoordinate" name="allCoordinate"
                                                value="${route_Coordinate[y + 1]}" readonly>
                                        </form>`;
                                    }
                                }
                                output.innerHTML += htmlContent; // Append the HTML content
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        });
    </script>
    {% endblock %}